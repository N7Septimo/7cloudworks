trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

# ---- Variables you wire up in Azure DevOps → Pipelines → Variables ----
variables:
  CLOUDFLARE_API_TOKEN: $(CLOUDFLARE_API_TOKEN)
  CLOUDFLARE_ACCOUNT_ID: $(CLOUDFLARE_ACCOUNT_ID)
  CLOUDFLARE_PROJECT: "7cloudworks"          # change if your Pages project name is different
  BUILD_OUTPUT_DIR: "dist"
  FLOWSIGHT_ENDPOINT: "https://YOUR-FLOWSIGHT-WORKER-URL/deploy"  # replace with real URL

# ======================================================================
# STAGES
# ======================================================================
stages:

# ----------------------------------------------------------------------
# 1) BUILD – prepare static site artifact
# ----------------------------------------------------------------------
- stage: Build
  displayName: "Build static portfolio"
  jobs:
    - job: BuildSite
      displayName: "Compile 7CloudWorks.io static website"

      steps:
        - checkout: self
          displayName: "Checkout repo"

        # For a pure static site, we just stage files into dist/.
        # If you later add a real build (Astro/Next/etc), plug it here.
        - script: |
            echo "Preparing static site..."
            cd "$(Build.SourcesDirectory)"

            rm -rf "$(BUILD_OUTPUT_DIR)"
            mkdir -p "$(BUILD_OUTPUT_DIR)"

            # Copy everything except Azure pipeline noise
            rsync -av \
              --exclude=".git" \
              --exclude="azure-pipelines.yml" \
              ./ "$(BUILD_OUTPUT_DIR)"/

            echo "Contents of $(BUILD_OUTPUT_DIR):"
            ls -la "$(BUILD_OUTPUT_DIR)"
          displayName: "Stage static files into dist/"

        - task: PublishBuildArtifacts@1
          displayName: "Publish website artifact"
          inputs:
            pathToPublish: "$(Build.SourcesDirectory)/$(BUILD_OUTPUT_DIR)"
            artifactName: "website"
            publishLocation: "Container"

# ----------------------------------------------------------------------
# 2) DEPLOY – push artifact to Cloudflare Pages
# ----------------------------------------------------------------------
- stage: Deploy
  displayName: "Deploy to Cloudflare Pages"
  dependsOn: Build
  condition: succeeded()
  jobs:
    - job: DeployToCloudflare
      displayName: "Upload new version to Cloudflare Pages"

      steps:
        - download: current
          artifact: website
          displayName: "Download website artifact"

        - task: NodeTool@0
          displayName: "Install Node.js 18"
          inputs:
            versionSpec: '18.x'

        - script: |
            echo "Installing Wrangler CLI..."
            npm install -g wrangler

            echo "Deploying to Cloudflare Pages project: $(CLOUDFLARE_PROJECT)"

            wrangler pages publish "$(Pipeline.Workspace)/website" \
              --project-name="$(CLOUDFLARE_PROJECT)" \
              --branch="main"
          displayName: "Publish site via Wrangler"
          env:
            CLOUDFLARE_API_TOKEN: $(CLOUDFLARE_API_TOKEN)
            CLOUDFLARE_ACCOUNT_ID: $(CLOUDFLARE_ACCOUNT_ID)

# ----------------------------------------------------------------------
# 3) NOTIFY – let FlowSight know a deploy happened
# ----------------------------------------------------------------------
- stage: Notify
  displayName: "Notify FlowSight Core"
  dependsOn: Deploy
  condition: succeeded()
  jobs:
    - job: NotifyFlowsight
      displayName: "Send deployment metadata to FlowSight"

      steps:
        - script: |
            echo "Notifying FlowSight at: $(FLOWSIGHT_ENDPOINT)"

            curl -X POST "$(FLOWSIGHT_ENDPOINT)" \
              -H "Content-Type: application/json" \
              -d "{\"site\":\"7cloudworks.io\",\
\"buildId\":\"$(Build.BuildId)\",\
\"pipeline\":\"$(Build.DefinitionName)\",\
\"runId\":\"$(Build.BuildId)\",\
\"timestamp\":\"$(Build.FinishTime)\",\
\"result\":\"success\"}"

          displayName: "POST deploy event to FlowSight"